<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TimeSync - Global Time Zone Planner</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23667eea'/><text x='50%25' y='55%25' text-anchor='middle' fill='%23fff' font-size='42' font-family='Arial' dy='.3em'>⏰</text></svg>" type="image/svg+xml" />
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --accent: #f093fb;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
      --info: #4299e1;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f7fafc;
      --bg-card: #ffffff;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --text-muted: #a0aec0;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-lg: 16px;
    }

    [data-theme='dark'] {
      --bg-primary: #1a202c;
      --bg-secondary: #2d3748;
      --bg-card: #2d3748;
      --text-primary: #f7fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #a0aec0;
      --border: #4a5568;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: white;
    }

    .header h1 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .main-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .toolbar-left {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .controls {
      padding: 2rem;
      background: var(--bg-primary);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .input-group label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-field {
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .timezone-input-wrapper {
      position: relative;
      display: flex;
      gap: 0.75rem;
    }

    .timezone-input-wrapper .input-field {
      flex: 1;
    }

    .add-zone-btn {
      background: linear-gradient(135deg, var(--success), #38a169);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .add-zone-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .selected-zones {
      margin-bottom: 2rem;
    }

    .selected-zones h3 {
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 600;
    }

    .zone-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .zone-chip {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 2rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideIn 0.3s ease;
    }

    .zone-chip .remove-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .zone-chip .remove-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.85rem;
      font-weight: 500;
      border: 2px solid transparent;
    }

    .legend-item.work { 
      background: linear-gradient(135deg, #c6f6d5, #9ae6b4); 
      color: #22543d;
    }
    .legend-item.sleep { 
      background: linear-gradient(135deg, #e2e8f0, #cbd5e0); 
      color: #2d3748;
    }
    .legend-item.off { 
      background: linear-gradient(135deg, #fef5e7, #fbd38d); 
      color: #744210;
    }
    .legend-item.smart { 
      background: linear-gradient(135deg, var(--success), #38a169); 
      color: white;
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: var(--bg-primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead th {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.25rem 1rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      transition: all 0.2s ease;
    }

    tbody tr:hover td {
      background-color: var(--bg-secondary) !important;
    }

    tbody td small {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
      font-weight: 400;
    }

    .time-cell.work { 
      background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
      color: #22543d;
    }
    .time-cell.sleep { 
      background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
      color: #2d3748;
    }
    .time-cell.off { 
      background: linear-gradient(135deg, #fef5e7, #fbd38d);
      color: #744210;
    }

    .smart-slot td {
      background: linear-gradient(135deg, var(--success), #38a169) !important;
      color: white !important;
      font-weight: 700;
      position: relative;
    }

    .smart-slot td::before {
      content: '✨';
      position: absolute;
      left: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 1rem;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .theme-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: var(--border);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    [data-theme='dark'] .theme-toggle {
      background: var(--primary);
    }

    [data-theme='dark'] .theme-toggle::after {
      transform: translateX(30px);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .app-container {
        padding: 0.5rem;
      }

      .header h1 {
        font-size: 2.5rem;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .toolbar-left {
        justify-content: center;
      }

      .controls {
        padding: 1.5rem;
      }

      .controls-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .timezone-input-wrapper {
        flex-direction: column;
      }

      .legend {
        padding: 1rem;
      }

      .legend-item {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }

      thead th {
        padding: 1rem 0.5rem;
        font-size: 0.8rem;
      }

      tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
      }
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
      }
      
      .toolbar, .controls {
        display: none;
      }
      
      .main-card {
        box-shadow: none;
        border: 1px solid #000;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <h1>⏰ TimeSync</h1>
      <p>Plan events across time zones with confidence</p>
    </header>

    <div class="main-card">
      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn btn-primary" onclick="exportPDF()">
            📄 Export PDF
          </button>
          <button class="btn btn-secondary" onclick="shareSchedule()">
            🔗 Share
          </button>
        </div>
        <div class="theme-toggle" onclick="toggleDarkMode()" title="Toggle dark mode"></div>
      </div>

      <div class="controls">
        <div class="controls-grid">
          <div class="input-group">
            <label for="input-date">Event Date</label>
            <input type="date" id="input-date" class="input-field" />
          </div>
          
          <div class="input-group">
            <label for="input-time">Event Time</label>
            <input type="time" id="input-time" class="input-field" step="1800" />
          </div>

          <div class="input-group">
            <label for="event-timezone">Event Time Zone</label>
            <input 
              id="event-timezone" 
              class="input-field" 
              list="event-tz-list" 
              placeholder="e.g., America/New_York"
              autocomplete="off"
            />
          </div>

          <div class="input-group">
            <label for="input-duration">Duration</label>
            <select id="input-duration" class="input-field">
              <option value="2">2 hours (4 slots)</option>
              <option value="4" selected>4 hours (8 slots)</option>
              <option value="6">6 hours (12 slots)</option>
              <option value="8">8 hours (16 slots)</option>
              <option value="12">12 hours (24 slots)</option>
              <option value="24">Full day (48 slots)</option>
            </select>
          </div>
        </div>

        <div class="input-group" style="margin-bottom: 2rem;">
          <label for="zone-input">Add Viewer Time Zones</label>
          <div class="timezone-input-wrapper">
            <input 
              id="zone-input" 
              class="input-field" 
              list="tz-list" 
              placeholder="Add locations of people viewing this event"
              autocomplete="off"
            />
            <button class="add-zone-btn" onclick="addZone()">
              ➕ Add
            </button>
          </div>
        </div>

        <div class="selected-zones" id="selected-zones-container" style="display: none;">
          <h3>Viewer Time Zones</h3>
          <div class="zone-chips" id="selected-zones"></div>
        </div>

        <div class="legend">
          <div class="legend-item work">💼 Work Hours (8AM - 5PM)</div>
          <div class="legend-item sleep">🌙 Sleep Hours (10PM - 6AM)</div>
          <div class="legend-item off">🕐 Off Hours</div>
          <div class="legend-item smart">✨ Optimal Event Time</div>
          <div class="legend-item">💡 * indicates Daylight Saving Time</div>
        </div>
      </div>

      <div class="table-container">
        <div id="empty-state" class="empty-state">
          <div class="icon">🌍</div>
          <h3>Ready to plan your global event?</h3>
          <p>Set your event date, time, and timezone, then add viewer locations to see when it occurs for everyone</p>
        </div>
        
        <table id="timezone-table" style="display: none;">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <datalist id="tz-list"></datalist>
  <datalist id="event-tz-list"></datalist>

  <script>
// In-memory storage for the artifact environment
const storage = {
  zones: [],
  theme: null,
  
  getItem: function(key) {
    if (key === "timesync-zones") return JSON.stringify(this.zones);
    if (key === "timesync-theme") return this.theme;
    return null;
  },
  
  setItem: function(key, value) {
    if (key === "timesync-zones") this.zones = JSON.parse(value);
    if (key === "timesync-theme") this.theme = value;
  }
};

let selectedZones = JSON.parse(storage.getItem("timesync-zones") || "[]");

// Initialize time zone suggestions
const ianaTimeZones = [
  'UTC',
  'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
  'America/Toronto', 'America/Vancouver', 'America/Mexico_City', 'America/Sao_Paulo',
  'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Rome', 'Europe/Madrid',
  'Europe/Amsterdam', 'Europe/Stockholm', 'Europe/Warsaw', 'Europe/Prague',
  'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Hong_Kong', 'Asia/Singapore', 'Asia/Seoul',
  'Asia/Mumbai', 'Asia/Dubai', 'Asia/Bangkok', 'Asia/Jakarta', 'Asia/Manila',
  'Australia/Sydney', 'Australia/Melbourne', 'Australia/Perth', 'Australia/Brisbane',
  'Pacific/Auckland', 'Pacific/Honolulu', 'Pacific/Fiji',
  'Africa/Cairo', 'Africa/Lagos', 'Africa/Johannesburg', 'Africa/Nairobi'
];

function populateTimezoneList() {
  const datalist = document.getElementById("tz-list");
  const eventDatalist = document.getElementById("event-tz-list");
  
  const options = ianaTimeZones.slice(0, 20).map(z => `<option value="${z}"></option>`).join("");
  
  if (datalist) {
    datalist.innerHTML = options;
  }
  if (eventDatalist) {
    eventDatalist.innerHTML = options;
  }
}

function updateZoneDisplay() {
  const container = document.getElementById("selected-zones");
  const wrapper = document.getElementById("selected-zones-container");
  
  if (selectedZones.length === 0) {
    wrapper.style.display = 'none';
    return;
  }
  
  wrapper.style.display = 'block';
  container.innerHTML = selectedZones.map(zone => `
    <div class="zone-chip">
      <span>${zone.replace('_', ' ')}</span>
      <button class="remove-btn" onclick="removeZone('${zone}')" title="Remove ${zone}">
        ✕
      </button>
    </div>
  `).join('');
}

function initTheme() {
  const saved = storage.getItem("timesync-theme");
  if (saved === "dark" || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.setAttribute('data-theme', 'dark');
  }
}

function toggleDarkMode() {
  const body = document.body;
  const isDark = body.getAttribute('data-theme') === 'dark';
  body.setAttribute('data-theme', isDark ? 'light' : 'dark');
  storage.setItem("timesync-theme", isDark ? 'light' : 'dark');
}

function addZone() {
  const input = document.getElementById("zone-input");
  if (!input) return;
  
  let zone = input.value.trim();
  
  if (!zone) {
    input.focus();
    return;
  }
  
  if (selectedZones.includes(zone)) {
    console.log(`⚠️ ${zone} is already added`);
    input.value = "";
    input.focus();
    return;
  }
  
  const zonesToTry = [
    zone,
    zone.replace(/\s+/g, '_'),
    zone.replace(/_/g, ' '),
    zone.split('/').map(part => 
      part.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join('_')
    ).join('/'),
    zone.toUpperCase() === 'EST' ? 'America/New_York' : zone,
    zone.toUpperCase() === 'PST' ? 'America/Los_Angeles' : zone,
    zone.toUpperCase() === 'MST' ? 'America/Denver' : zone,
    zone.toUpperCase() === 'CST' ? 'America/Chicago' : zone,
    zone.toUpperCase() === 'GMT' ? 'Europe/London' : zone,
    zone.toUpperCase() === 'UTC' ? 'UTC' : zone
  ];
  
  let validZone = null;
  for (const testZone of zonesToTry) {
    try {
      if (testZone === 'UTC') {
        validZone = 'UTC';
        console.log(`Valid time zone found: UTC`);
        break;
      } else {
        new Intl.DateTimeFormat("en-US", { timeZone: testZone }).format(new Date());
        validZone = testZone;
        console.log(`Valid time zone found: ${testZone}`);
        break;
      }
    } catch (e) {
      console.log(`Invalid time zone: ${testZone}`);
    }
  }
  
  if (validZone) {
    selectedZones.push(validZone);
    storage.setItem("timesync-zones", JSON.stringify(selectedZones));
    input.value = "";
    input.focus();
    updateZoneDisplay();
    console.log('About to generate table after adding zone:', validZone);
    generateTable();
    console.log(`✅ Added ${validZone}`);
  } else {
    console.log(`Failed to validate any variation of: ${zone}`);
    console.log(`❌ Invalid time zone: "${zone}". Try selecting from dropdown suggestions.`);
    input.focus();
    input.select();
  }
}

function removeZone(zone) {
  selectedZones = selectedZones.filter(z => z !== zone);
  storage.setItem("timesync-zones", JSON.stringify(selectedZones));
  updateZoneDisplay();
  generateTable();
}

function utcToZonedTime(date, timeZone) {
  const localString = date.toLocaleString('en-US', {
    timeZone: timeZone,
    hour12: false
  });

  const [datePart, timePart] = localString.split(', ');
  const [month, day, year] = datePart.split('/');
  const [hour, minute, second = '00'] = timePart.split(':');

  return new Date(`${year.padStart(4, '0')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${hour.padStart(2, '0')}:${minute.padStart(2, '0')}:${second.padStart(2, '0')}`);
}

function generateTable() {
  console.log('🚀 NEW generateTable called');
  const dateInput = document.getElementById("input-date");
  const timeInput = document.getElementById("input-time");
  const eventTimezoneInput = document.getElementById("event-timezone");
  const durationInput = document.getElementById("input-duration");
  const table = document.getElementById("timezone-table");
  const emptyState = document.getElementById("empty-state");
  
  if (!dateInput || !timeInput || !eventTimezoneInput || !durationInput || !table || !emptyState) {
    console.log("❌ Required DOM elements not found");
    return;
  }
  
  const dateStr = dateInput.value;
  const timeStr = timeInput.value;
  const eventTimezone = eventTimezoneInput.value.trim();
  const durationHours = parseInt(durationInput.value || "4");
  
  console.log('📊 Inputs:', {
    date: dateStr,
    time: timeStr, 
    eventTz: eventTimezone,
    duration: durationHours
  });
  
  // Show empty state if missing critical info
  if (!dateStr || !timeStr || !eventTimezone) {
    console.log('❌ Missing required fields - showing empty state');
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  // Validate event timezone
  let validEventTimezone = null;
  try {
    if (eventTimezone === 'UTC') {
      validEventTimezone = 'UTC';
    } else {
      new Intl.DateTimeFormat("en-US", { timeZone: eventTimezone }).format(new Date());
      validEventTimezone = eventTimezone;
    }
    console.log('✅ Valid event timezone:', validEventTimezone);
  } catch (e) {
    console.log('❌ Invalid event timezone:', eventTimezone);
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  // CREATE EVENT TIME - this is the key fix!
  const [year, month, day] = dateStr.split("-").map(Number);
  const [hours, minutes] = timeStr.split(":").map(Number);
  
  let eventTimeUTC;
  if (validEventTimezone === 'UTC') {
    eventTimeUTC = new Date(Date.UTC(year, month - 1, day, hours, minutes));
  } else {
    // Simple approach: create date in event timezone
    const eventDate = new Date(year, month - 1, day, hours, minutes);
    const utcDate = new Date(eventDate.toLocaleString('en-US', { timeZone: 'UTC' }));
    const tzDate = new Date(eventDate.toLocaleString('en-US', { timeZone: validEventTimezone }));
    const offset = utcDate.getTime() - tzDate.getTime();
    eventTimeUTC = new Date(eventDate.getTime() + offset);
  }

  console.log('🕐 Event time UTC:', eventTimeUTC.toISOString());

  // SHOW TABLE - this should always happen now!
  console.log('✅ Showing table with event timezone');
  table.style.display = 'table';
  emptyState.style.display = 'none';

  const tableHead = document.querySelector("#timezone-table thead");
  const tableBody = document.querySelector("#timezone-table tbody");
  
  if (!tableHead || !tableBody) {
    console.log("❌ Table elements not found");
    return;
  }
  
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  // CREATE HEADER - Event timezone FIRST, then viewers
  const headRow = document.createElement("tr");
  const eventDisplayName = validEventTimezone === 'UTC' ? 'UTC' : validEventTimezone.split('/').pop().replace('_', ' ');
  
  let headerContent = `<th style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">📍 ${eventDisplayName}<br><small>Event Time</small></th>`;
  console.log('📍 Added event header:', eventDisplayName);
  
  // Add viewer columns
  selectedZones.forEach(zone => {
    const displayName = zone === 'UTC' ? 'UTC' : zone.split('/').pop().replace('_', ' ');
    headerContent += `<th>👥 ${displayName}<br><small>Viewer</small></th>`;
    console.log('👥 Added viewer header:', displayName);
  });
  
  headRow.innerHTML = headerContent;
  tableHead.appendChild(headRow);

  // CREATE ROWS
  const totalSlots = durationHours * 2;
  console.log(`📊 Generating ${totalSlots} time slots`);

  for (let i = 0; i < totalSlots; i++) {
    const utcTime = new Date(eventTimeUTC.getTime() + i * 30 * 60 * 1000);
    const row = document.createElement("tr");
    let cells = [];

    // EVENT CELL (always first)
    let eventLocalTime;
    if (validEventTimezone === 'UTC') {
      eventLocalTime = utcTime;
    } else {
      eventLocalTime = utcToZonedTime(utcTime, validEventTimezone);
    }
    
    const eventHour = eventLocalTime.getHours();
    const eventLabel = eventLocalTime.toTimeString().slice(0, 5);
    const eventDay = eventLocalTime.toLocaleDateString('en-US', { 
      weekday: 'short', month: 'short', day: 'numeric' 
    });
    
    const eventClass = (eventHour >= 8 && eventHour < 17) ? "work" : 
                      (eventHour < 6 || eventHour >= 22) ? "sleep" : "off";
    
    cells.push(`<td class="time-cell ${eventClass}" style="font-weight: bold; border-left: 4px solid #667eea;">${eventLabel}<br><small>${eventDay}</small></td>`);

    // VIEWER CELLS
    selectedZones.forEach(zone => {
      if (zone === "UTC") {
        const utcHour = utcTime.getUTCHours();
        const utcLabel = utcTime.toISOString().slice(11, 16);
        const utcDay = utcTime.toLocaleDateString('en-US', { 
          weekday: 'short', month: 'short', day: 'numeric' 
        });
        
        const utcClass = (utcHour >= 8 && utcHour < 17) ? "work" : 
                        (utcHour < 6 || utcHour >= 22) ? "sleep" : "off";
        
        cells.push(`<td class="time-cell ${utcClass}">${utcLabel}<br><small>${utcDay}</small></td>`);
      } else {
        const local = utcToZonedTime(utcTime, zone);
        const localHour = local.getHours();
        const localLabel = local.toTimeString().slice(0, 5);
        const localDay = local.toLocaleDateString('en-US', { 
          weekday: 'short', month: 'short', day: 'numeric' 
        });
        
        const cls = (localHour >= 8 && localHour < 17) ? "work" : 
                    (localHour < 6 || localHour >= 22) ? "sleep" : "off";
        
        cells.push(`<td class="time-cell ${cls}">${localLabel}<br><small>${localDay}</small></td>`);
      }
    });

    row.innerHTML = cells.join("");
    tableBody.appendChild(row);
  }
  
  console.log('✅ Table generation complete!');
}

function exportPDF() {
  window.print();
}

function shareSchedule() {
  const zones = selectedZones.join(', ');
  const date = document.getElementById("input-date").value;
  const time = document.getElementById("input-time").value;
  const eventTz = document.getElementById("event-timezone").value;
  
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    console.log('📋 Schedule link copied to clipboard!');
  }).catch(() => {
    console.log('📋 Could not copy to clipboard');
  });
}

function isStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches || 
         window.navigator.standalone || 
         document.referrer.includes('android-app://');
}

// INITIALIZATION
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 TimeSync DOM loaded');
  
  initTheme();
  updateZoneDisplay();
  populateTimezoneList();
  
  // Set defaults
  const today = new Date().toISOString().split('T')[0];
  const currentTime = new Date().toTimeString().slice(0, 5);
  const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  
  const dateInput = document.getElementById("input-date");
  const timeInput = document.getElementById("input-time");
  const eventTimezoneInput = document.getElementById("event-timezone");
  
  if (dateInput) {
    dateInput.value = today;
    dateInput.addEventListener("change", generateTable);
  }
  
  if (timeInput) {
    timeInput.value = currentTime;
    timeInput.addEventListener("change", generateTable);
  }
  
  if (eventTimezoneInput) {
    eventTimezoneInput.value = userTimezone;
    eventTimezoneInput.addEventListener("change", () => {
      console.log('🌍 Event timezone changed to:', eventTimezoneInput.value);
      generateTable();
    });
    eventTimezoneInput.addEventListener("input", function() {
      const input = this.value.toLowerCase();
      const suggestions = ianaTimeZones.filter(z => z.toLowerCase().includes(input));
      
      let datalist = document.getElementById("event-tz-list");
      if (datalist) {
        datalist.innerHTML = suggestions.slice(0, 15).map(z => `<option value="${z}"></option>`).join("");
      }
    });
  }
  
  // Duration and zone inputs
  const durationInput = document.getElementById("input-duration");
  if (durationInput) {
    durationInput.addEventListener("change", generateTable);
  }
  
  const zoneInput = document.getElementById("zone-input");
  if (zoneInput) {
    zoneInput.addEventListener("keypress", function(e) {
      if (e.key === 'Enter') {
        addZone();
      }
    });
    
    zoneInput.addEventListener("input", function() {
      const input = this.value.toLowerCase();
      const suggestions = ianaTimeZones.filter(z => z.toLowerCase().includes(input));
      
      let datalist = document.getElementById("tz-list");
      if (datalist) {
        datalist.innerHTML = suggestions.slice(0, 15).map(z => `<option value="${z}"></option>`).join("");
      }
    });

    zoneInput.addEventListener("focus", populateTimezoneList);
  }
  
  // Generate initial table after everything is set up
  setTimeout(() => {
    console.log('🔄 Initial table generation...');
    generateTable();
  }, 500);

  if (isStandalone()) {
    document.body.classList.add('pwa-installed');
  }
});
  </script>
</body>
</html>
